<div class="user-management-container">
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="header-title">
        <div class="header-icon">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
        </div>
        <div class="header-text">
          <h1>ğŸ‘¥ Gestion des utilisateurs</h1>
          <p class="header-subtitle">GÃ©rer tous les utilisateurs de la plateforme</p>
        </div>
      </div>

      <div class="header-actions">
        <button class="btn-action" (click)="refreshData()" title="Actualiser">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
          </svg>
        </button>
        <button class="btn-action" (click)="navigateToAdminDashboard()" title="Retour au dashboard">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
        </button>
        <button class="btn-logout" (click)="logout()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          DÃ©connexion
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Statistics Cards -->
    <section class="stats-section">
      <div class="stat-card total-users-card">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-content">
          <div class="stat-value">{{ statistics().totalUsers }}</div>
          <div class="stat-label">Total Utilisateurs</div>
        </div>
      </div>

      <div class="stat-card doctors-card">
        <div class="stat-icon">ğŸ‘¨â€âš•ï¸</div>
        <div class="stat-content">
          <div class="stat-value">{{ doctorStatistics() }}</div>
          <div class="stat-label">MÃ©decins</div>
        </div>
      </div>

      <div class="stat-card admins-card">
        <div class="stat-icon">ğŸ”‘</div>
        <div class="stat-content">
          <div class="stat-value">{{ statistics().totalAdmins }}</div>
          <div class="stat-label">Administrateurs</div>
        </div>
      </div>
    </section>

    <!-- Filters Section -->
    <section class="filters-section">
      <!-- Role Chips -->
      <div class="role-chips">
        <button 
          class="chip"
          [class.active]="selectedRole() === null"
          (click)="loadAllUsersWithDoctors()">
          Tous
        </button>
        <button 
          class="chip"
          [class.active]="selectedRole() === 'USER'"
          (click)="filterByRole('USER')">
          Utilisateurs
        </button>
        <button 
          class="chip"
          [class.active]="selectedRole() === 'DOCTOR'"
          (click)="loadAllDoctors()">
          MÃ©decins
        </button>
        <button 
          class="chip"
          [class.active]="selectedRole() === 'ADMIN'"
          (click)="filterByRole('ADMIN')">
          Admins
        </button>
      </div>

      <!-- Search Bar -->
      <div class="search-bar">
        <input 
          type="text" 
          class="search-input"
          placeholder="Rechercher par nom, email..."
          [(ngModel)]="searchQuery"
          (keyup.enter)="onSearch()">
        <button class="search-button" (click)="onSearch()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </button>
      </div>
    </section>

    <!-- Loading State -->
    @if (loading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Chargement des utilisateurs...</p>
    </div>
    }

    <!-- Users Grid -->
    @if (!loading()) {
    <section class="users-section">
      @if (users().length > 0) {
      <div class="users-grid">
        @for (user of users(); track user.id) {
        <app-user-card
          [user]="user"
          (viewDetails)="onViewDetails(user)"
          (deleteUser)="!user.roles.includes('ADMIN') ? onDeleteUser(user) : null">
        </app-user-card>
        }
      </div>
      } @else {
      <div class="empty-state">
        <div class="empty-icon">ğŸ”</div>
        <h3>Aucun utilisateur trouvÃ©</h3>
        <p>Essayez de modifier vos critÃ¨res de recherche</p>
      </div>
      }
    </section>
    }
  </main>

  <!-- User Details Modal -->
  @if (showUserModal() && selectedUser()) {
  <div class="modal-overlay" (click)="closeUserModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“‹ DÃ©tails de l'utilisateur</h2>
        <button class="btn-close" (click)="closeUserModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="user-profile">
          <div class="profile-avatar">
            {{ selectedUser()!.fullName.charAt(0) }}
          </div>
          <h3 class="profile-name">{{ selectedUser()!.fullName }}</h3>
          <p class="profile-email">{{ selectedUser()!.email }}</p>
        </div>

      <!-- Remplacez la section des dÃ©tails dans votre modal par ceci -->
      <div class="details-grid">
        <div class="detail-row">
          <span class="detail-label">ğŸ‘¤ Nom:</span>
          <span class="detail-value">{{ selectedUser()!.fullName }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">ğŸ“§ Email:</span>
          <span class="detail-value">{{ selectedUser()!.email }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">ğŸ“± TÃ©lÃ©phone:</span>
          <span class="detail-value">{{ selectedUser()!.phoneNumber || 'Non renseignÃ©' }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">ğŸ­ RÃ´les:</span>
          <span class="detail-value">{{ selectedUser()!.roles.join(', ') }}</span>
        </div>
        
        <!-- âœ… Afficher activationStatus UNIQUEMENT pour les mÃ©decins -->
        @if (selectedUser()!.roles.includes('DOCTOR')) {
          <div class="detail-row">
            <span class="detail-label">ğŸ” Statut d'activation:</span>
            <span class="detail-value" 
                  [ngClass]="{
                    'status-pending': selectedUser()!.activationStatus === 'PENDING',
                    'status-approved': selectedUser()!.activationStatus === 'APPROVED',
                    'status-rejected': selectedUser()!.activationStatus === 'REJECTED'
                  }">
              {{ selectedUser()!.activationStatus || 'PENDING' }}
            </span>
          </div>
        }
        
        <div class="detail-row">
          <span class="detail-label">ğŸ“Š Statut du compte:</span>
          <span class="detail-value">{{ selectedUser()!.accountStatus }}</span>
        </div>
        
        <div class="detail-row">
          <span class="detail-label">âœ… ActivÃ©:</span>
          <span class="detail-value">{{ selectedUser()!.isActivated ? 'Oui' : 'Non' }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">âœ‰ï¸ Email vÃ©rifiÃ©:</span>
          <span class="detail-value">{{ selectedUser()!.isEmailVerified ? 'Oui' : 'Non' }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">ğŸ“… CrÃ©Ã© le:</span>
          <span class="detail-value">{{ selectedUser()!.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">ğŸ• DerniÃ¨re connexion:</span>
          <span class="detail-value">{{ selectedUser()!.lastLoginAt ? (selectedUser()!.lastLoginAt | date:'dd/MM/yyyy HH:mm') : 'Jamais' }}</span>
        </div>
      </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-close-modal" (click)="closeUserModal()">Fermer</button>
      </div>
    </div>
  </div>
  }
</div>